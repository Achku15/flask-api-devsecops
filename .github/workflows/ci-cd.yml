name: Pipeline CI/CD DevSecOps AWS

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AWS_REGION: "us-east-1"

jobs:

  # ============================
  # JOB 1 : INTÉGRATION CONTINUE
  # ============================
  continuous-integration:
    name: "CI - Tests & Sécurité"
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      actions: read
      contents: read
      packages: read

    steps:
      - name: "Checkout du code"
        uses: actions/checkout@v4

      - name: "Configuration Python"
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: "Installation des dépendances"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "Exécution des tests unitaires"
        run: pytest -v --junitxml=test-results.xml

      - name: "Publication des résultats de tests"
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml

      - name: "Analyse de qualité de code (Linting)"
        run: flake8 . --count --max-complexity=10 --max-line-length=127 --statistics

      - name: "Initialisation CodeQL (SAST)"
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: "Préparation CodeQL"
        run: |
          echo "Building application for CodeQL analysis..."
          python -m py_compile app.py test_app.py

      - name: "Analyse de sécurité CodeQL"
        uses: github/codeql-action/analyze@v3

  # ============================
  # JOB 2 : DÉPLOIEMENT AWS
  # ============================
  continuous-deployment:
    name: "CD - Déploiement AWS"
    needs: continuous-integration
    runs-on: ubuntu-latest
    environment: production

    permissions:
      security-events: write
      contents: read
      packages: write

    steps:
      - name: "Checkout du code"
        uses: actions/checkout@v4

      - name: "Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Connexion au GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
